<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MakeFriend – เมคเฟรนรวมเพื่อนทุกคณะ (Yellow/Gray)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{color-scheme:dark;}
    .line-clamp-2{display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  </style>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-gray-950/70 border-b border-gray-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-8 h-8 rounded-xl bg-amber-400 text-gray-900 font-black grid place-items-center">MF</div>
      <div class="flex-1">
        <h1 class="text-base font-bold leading-tight">MakeFriend – เมคเฟรนรวมเพื่อนทุกคณะ</h1>
        <p class="text-[11px] text-gray-400">ธีมเหลือง–เทา · หาเพื่อน เข้ากลุ่ม คณะ/สาขา · Pure HTML + JS</p>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <div id="exportImport"></div>
        <button id="btnManageGroups" class="px-3 py-2 rounded-xl border border-amber-400/40 text-amber-300 hover:bg-amber-400/10 text-sm">จัดการลิงก์กลุ่ม</button>
        <button id="btnAddProfile" class="px-3 py-2 rounded-xl bg-amber-400 text-gray-900 font-semibold hover:bg-amber-300 text-sm">+ เพิ่มโปรไฟล์</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Filters + Groups -->
    <div class="lg:col-span-1">
      <section class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-100">ค้นหา/กรอง</h2>
          <button id="btnClearFilters" class="text-xs text-gray-300 hover:text-amber-300">ล้างตัวกรอง</button>
        </div>
        <div class="bg-gray-800/60 rounded-2xl border border-gray-700/60 p-3 space-y-2">
          <input id="q" placeholder="พิมพ์ชื่อ/สาขา/จังหวัด/คณะ" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/>
          <select id="faculty" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"></select>
          <input id="major" list="majors" placeholder="กรองตามสาขา" class="w-full bg-gray-900 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/>
          <datalist id="majors"></datalist>
          <div class="flex gap-2 pt-1 md:hidden">
            <button id="btnManageGroupsSm" class="flex-1 px-3 py-2 rounded-xl border border-amber-400/40 text-amber-300 hover:bg-amber-400/10 text-sm">จัดการลิงก์กลุ่ม</button>
            <button id="btnAddProfileSm" class="flex-1 px-3 py-2 rounded-xl bg-amber-400 text-gray-900 font-semibold hover:bg-amber-300 text-sm">+ เพิ่มโปรไฟล์</button>
          </div>
        </div>
      </section>

      <section class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-100">ลิงก์เข้ากลุ่มคณะ/สาขา</h2>
          <span id="groupsCount" class="text-xs text-gray-400"></span>
        </div>
        <div id="groupsList" class="bg-gray-800/60 rounded-2xl border border-gray-700/60 p-3 space-y-2"></div>
      </section>
    </div>

    <!-- Profiles -->
    <div class="lg:col-span-2">
      <section class="mb-6">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold text-gray-100">คนที่กำลังจะเป็นเพื่อนใหม่</h2>
          <span id="profilesCount" class="text-xs text-gray-400"></span>
        </div>
        <div class="bg-gray-800/60 rounded-2xl border border-gray-700/60 p-3">
          <div id="profilesGrid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3"></div>
          <div id="profilesEmpty" class="hidden text-center text-sm text-gray-400 py-10">ยังไม่มีโปรไฟล์ตรงกับที่ค้นหา ลองลบตัวกรองหรือเพิ่มโปรไฟล์ใหม่</div>
        </div>
      </section>
    </div>
  </main>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 pb-10">
    <div class="bg-gray-900/60 border border-gray-800 rounded-2xl p-4 flex flex-col sm:flex-row items-center justify-between gap-3">
      <div class="text-[12px] text-gray-400">
        สร้างเพื่อเมคเฟรน · เก็บข้อมูลไว้ในเบราว์เซอร์ของคุณ (LocalStorage) · ธีมเหลือง–เทา
      </div>
      <div class="flex items-center gap-2 text-[12px]">
        <a href="#" class="px-2 py-1 rounded-lg border border-amber-400/40 text-amber-300 hover:bg-amber-400/10">ข้อเสนอแนะ</a>
        <a href="#" class="px-2 py-1 rounded-lg border border-amber-400/40 text-amber-300 hover:bg-amber-400/10">นโยบายความเป็นส่วนตัว</a>
      </div>
    </div>
  </footer>

  <!-- Profile Drawer -->
  <div id="drawer" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute right-0 top-0 bottom-0 w-full sm:w-[420px] bg-gray-900 border-l border-gray-700 p-4 overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-100">โปรไฟล์</h3>
        <button class="text-gray-400 hover:text-gray-200" data-close>ปิด</button>
      </div>
      <div id="drawerBody"></div>
    </div>
  </div>

  <!-- Add Profile Modal -->
  <div id="addModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-x-0 bottom-0 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-[720px] bg-gray-900 border border-gray-700 rounded-t-3xl sm:rounded-2xl p-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-100">เพิ่มโปรไฟล์</h3>
        <button class="text-gray-400 hover:text-gray-200" data-close>ปิด</button>
      </div>
      <form id="addForm" class="grid grid-cols-1 sm:grid-cols-2 gap-3"></form>
    </div>
  </div>

  <!-- Manage Groups Modal -->
  <div id="groupsModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60" data-close></div>
    <div class="absolute inset-x-0 bottom-0 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-[820px] bg-gray-900 border border-gray-700 rounded-t-3xl sm:rounded-2xl p-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold text-gray-100">จัดการลิงก์เข้ากลุ่ม คณะ/สาขา</h3>
        <button class="text-gray-400 hover:text-gray-200" data-close>ปิด</button>
      </div>
      <div id="groupsEditor" class="space-y-4"></div>
      <div class="flex justify-between pt-3">
        <button id="btnAddGroupRow" class="px-3 py-2 rounded-xl border border-gray-600 text-gray-200 hover:bg-gray-800">เพิ่มชุดคณะ/สาขา</button>
        <button id="btnSaveGroups" class="px-4 py-2 rounded-xl bg-amber-400 text-gray-900 font-semibold hover:bg-amber-300">บันทึกทั้งหมด</button>
      </div>
    </div>
  </div>

  <script>
  // ===== Data & Utils =====
  const FACULTIES = [
    "คณะพยาบาลศาสตร์",
    "คณะแพทยศาสตร์",
    "คณะเภสัชศาสตร์",
    "คณะสัตวแพทยศาสตร์",
    "คณะสาธารณสุขศาสตร์",
    "คณะเทคโนโลยี",
    "คณะวิทยาการสารสนเทศ",
    "คณะวิทยาศาสตร์",
    "คณะวิศวกรรมศาสตร์",
    "คณะสถาปัตยกรรมศาสตร์ ผังเมืองและนฤมิตศิลป์",
    "คณะสิ่งแวดล้อมและทรัพยากรศาสตร์",
    "วิทยาลัยการเมืองการปกครอง",
    "คณะศึกษาศาสตร์",
    "คณะนิติศาสตร์",
    "คณะการบัญชีและการจัดการ",
    "วิทยาลัยดุริยางคศิลป์",
    "อื่น ๆ",
  ];

  const DEFAULT_GROUPS = [
    { id: crypto.randomUUID(), faculty: "วิทยาลัยการเมืองการปกครอง", major: "การเมืองการปกครอง", links: [
      { type: "LINE", url: "https://line.me/R/ti/g/example-cpg" },
      { type: "Facebook Group", url: "https://facebook.com/groups/example-cpg" },
    ]},
    { id: crypto.randomUUID(), faculty: "คณะวิศวกรรมศาสตร์", major: "วิศวกรรมคอมพิวเตอร์", links: [
      { type: "Discord", url: "https://discord.gg/example-ce" },
    ]},
  ];

  const SAMPLE_PROFILES = [
    { id: crypto.randomUUID(), name: "ชัชพล นามสมมติ", nickname: "โฟร์ค", faculty: "วิทยาลัยการเมืองการปกครอง", major: "การเมืองการปกครอง", province: "กาฬสินธุ์", bio: "อยากหาเพื่อนไปร่วมกิจกรรมมหาลัย ชอบทำเว็บ ดีลได้ทุกคณะ", socials: { facebook: "https://facebook.com/example.folk", instagram: "https://instagram.com/example.folk", tiktok: "https://tiktok.com/@example.folk", line: "https://line.me/ti/p/~examplefolk" }, avatar: "https://api.dicebear.com/8.x/fun-emoji/svg?seed=Folk", createdAt: Date.now()},
    { id: crypto.randomUUID(), name: "ศิริวรรณ ทองดี", nickname: "ออม", faculty: "คณะวิศวกรรมศาสตร์", major: "วิศวกรรมคอมพิวเตอร์", province: "ขอนแก่น", bio: "สาวสายโค้ด ชอบเพลง R&B หาทีมทำโปรเจ็กต์", socials: { instagram: "https://instagram.com/example.aom", discord: "https://discordapp.com/users/0000000000" }, avatar: "https://api.dicebear.com/8.x/fun-emoji/svg?seed=Aom", createdAt: Date.now()-86400000},
  ];

  const load = (k, fb) => { try{ const v = localStorage.getItem(k); return v? JSON.parse(v): fb; } catch(e){ return fb; } };
  const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  let state = {
    profiles: load('mf_profiles', SAMPLE_PROFILES),
    groups: load('mf_groups', DEFAULT_GROUPS),
    q: '',
    faculty: '',
    major: ''
  };

  // ===== Elements =====
  const el = (id) => document.getElementById(id);
  const qEl = el('q'), facultyEl = el('faculty'), majorEl = el('major');
  const profilesGrid = el('profilesGrid'), profilesCount = el('profilesCount'), profilesEmpty = el('profilesEmpty');
  const groupsList = el('groupsList'), groupsCount = el('groupsCount');

  // ===== Render Functions =====
  function renderFacultyOptions(){
    facultyEl.innerHTML = '<option value="">— ทุกคณะ —</option>' + FACULTIES.map(f=>`<option value="${f}">${f}</option>`).join('');
    facultyEl.value = state.faculty;
  }

  function majorsFromFaculty(){
    const s = new Set();
    state.groups.filter(g=>!state.faculty || g.faculty===state.faculty).forEach(g=>g.major && s.add(g.major));
    state.profiles.filter(p=>!state.faculty || p.faculty===state.faculty).forEach(p=>p.major && s.add(p.major));
    return Array.from(s);
  }

  function renderMajorsDatalist(){
    const list = majorsFromFaculty();
    el('majors').innerHTML = list.map(m=>`<option value="${m}">`).join('');
  }

  function profileCard(p){
    return `<button class="group text-left w-full bg-gray-900/60 hover:bg-gray-900 border border-gray-700/60 rounded-2xl overflow-hidden shadow-sm" data-open-profile="${p.id}">
      <div class="flex gap-3 p-3 items-center">
        <img src="${p.avatar}" alt="${p.nickname}" class="w-12 h-12 rounded-2xl ring-1 ring-gray-700 object-cover"/>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2">
            <p class="text-sm text-gray-100 font-semibold truncate">${p.name}</p>
            <span class="inline-flex items-center rounded-full bg-amber-400/20 text-amber-300 ring-1 ring-amber-400/40 px-2 py-0.5 text-[11px] font-medium">"${p.nickname}"</span>
          </div>
          <p class="text-xs text-gray-300/90 truncate">${p.faculty} · ${p.major||'-'}</p>
        </div>
        <div class="text-[10px] text-gray-400">${new Date(p.createdAt).toLocaleDateString()}</div>
      </div>
      ${p.bio? `<div class="px-3 pb-3 text-xs text-gray-300/90 line-clamp-2">${p.bio}</div>`: ''}
    </button>`;
  }

  function renderProfiles(){
    let list = state.profiles
      .filter(p=>!state.faculty || p.faculty===state.faculty)
      .filter(p=>!state.major || (p.major||'').toLowerCase().includes(state.major.toLowerCase()))
      .filter(p=>{
        if(!state.q) return true;
        const t = `${p.name} ${p.nickname} ${p.faculty} ${p.major} ${p.bio} ${p.province}`.toLowerCase();
        return t.includes(state.q.toLowerCase());
      })
      .sort((a,b)=>b.createdAt-a.createdAt);
    profilesGrid.innerHTML = list.map(profileCard).join('');
    profilesCount.textContent = list.length + ' โปรไฟล์';
    profilesEmpty.classList.toggle('hidden', list.length!==0);
  }

  function renderGroups(){
    const list = state.groups.filter(g=>(!state.faculty || g.faculty===state.faculty) && (!state.major || (g.major||'').toLowerCase().includes(state.major.toLowerCase())));
    groupsList.innerHTML = list.map(g=>`
      <div class="p-3 bg-gray-900/60 rounded-xl border border-gray-700/60">
        <div class="text-sm text-gray-200 font-medium">${g.faculty}${g.major? ` · ${g.major}`:''}</div>
        <div class="mt-2 flex flex-wrap gap-2">
          ${g.links.map(l=>`<a href="${l.url}" target="_blank" rel="noreferrer" class="text-xs px-2 py-1 rounded-lg border border-amber-400/40 text-amber-300 hover:bg-amber-400/10">${l.type}</a>`).join('')}
        </div>
      </div>`).join('');
    groupsCount.textContent = list.length + ' รายการ';
  }

  function renderAll(){
    renderFacultyOptions();
    renderMajorsDatalist();
    renderProfiles();
    renderGroups();
  }

  // ===== Drawer =====
  function openDrawer(p){
    const d = el('drawer');
    const s = p.socials || {};
    const item = (label, value) => `<div class="flex gap-2 text-sm"><span class="text-gray-400 w-24">${label}</span><span class="text-gray-100 break-all">${value||'-'}</span></div>`;
    const link = (label, url) => `<a href="${url}" target="_blank" rel="noreferrer" class="inline-flex items-center text-xs px-2 py-1 rounded-lg border border-amber-400/40 text-amber-300 hover:bg-amber-400/10">${label}</a>`;
    el('drawerBody').innerHTML = `
      <div class="flex items-start gap-3 mb-4">
        <img src="${p.avatar}" alt="${p.nickname}" class="w-16 h-16 rounded-2xl ring-1 ring-gray-700"/>
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-2 flex-wrap">
            <p class="text-gray-100 font-semibold">${p.name}</p>
            <span class="inline-flex items-center rounded-full bg-amber-400/20 text-amber-300 ring-1 ring-amber-400/40 px-2 py-0.5 text-[11px] font-medium">"${p.nickname}"</span>
          </div>
          <p class="text-xs text-gray-300">${p.faculty} · ${p.major||'-'}</p>
        </div>
      </div>
      ${p.bio? `<p class="text-sm text-gray-200 mb-4 whitespace-pre-wrap">${p.bio}</p>`:''}
      <div class="space-y-2">
        ${item('จังหวัด', p.province)}
        ${item('ช่องทาง', '')}
        <div class="flex flex-wrap gap-2">
          ${s.facebook? link('Facebook', s.facebook): ''}
          ${s.instagram? link('Instagram', s.instagram): ''}
          ${s.tiktok? link('TikTok', s.tiktok): ''}
          ${s.line? link('LINE', s.line): ''}
          ${s.discord? link('Discord', s.discord): ''}
          ${s.other? link('อื่น ๆ', s.other): ''}
        </div>
      </div>`;
    d.classList.remove('hidden');
  }
  function closeDrawer(){ el('drawer').classList.add('hidden'); }

  // ===== Add Profile Modal =====
  function openAddModal(){
    const m = el('addModal');
    const form = el('addForm');
    const opts = FACULTIES.map(f=>`<option value="${f}">${f}</option>`).join('');
    form.innerHTML = `
      <label class="block text-sm text-gray-300">ชื่อ-สกุล<input name="name" required class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/></label>
      <label class="block text-sm text-gray-300">ชื่อเล่น<input name="nickname" required class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/></label>
      <label class="block text-sm text-gray-300">คณะ<select name="faculty" required class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"><option value="">— เลือกคณะ —</option>${opts}</select></label>
      <label class="block text-sm text-gray-300">สาขา<input name="major" placeholder="เช่น รัฐศาสตร์/การเมืองการปกครอง" class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/></label>
      <label class="block text-sm text-gray-300">จังหวัด<input name="province" class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/></label>
      <label class="block text-sm text-gray-300">ลิงก์รูปโปรไฟล์ (ไม่บังคับ)<input name="avatar" placeholder="https://..." class="mt-1 w-full bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/></label>
      <label class="block text-sm text-gray-300 sm:col-span-2">แนะนำตัว<textarea name="bio" class="mt-1 w-full h-[120px] bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100" placeholder="สิ่งที่ชอบ สิ่งที่ถนัด กิจกรรมที่อยากทำ"></textarea></label>
      <div class="grid grid-cols-2 gap-2 sm:col-span-2">
        <input name="facebook" placeholder="Facebook URL" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
        <input name="instagram" placeholder="Instagram URL" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
        <input name="tiktok" placeholder="TikTok URL" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
        <input name="line" placeholder="LINE URL" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
        <input name="discord" placeholder="Discord URL" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
        <input name="other" placeholder="อื่น ๆ (URL)" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100 text-sm"/>
      </div>
      <div class="sm:col-span-2 flex justify-end gap-2 pt-2">
        <button type="button" class="px-4 py-2 rounded-xl border border-gray-600 text-gray-200 hover:bg-gray-800" data-close>ยกเลิก</button>
        <button class="px-4 py-2 rounded-xl bg-amber-400 text-gray-900 font-semibold hover:bg-amber-300">บันทึก</button>
      </div>`;
    form.onsubmit = (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const obj = Object.fromEntries(fd.entries());
      const socials = { facebook: obj.facebook||'', instagram: obj.instagram||'', tiktok: obj.tiktok||'', line: obj.line||'', discord: obj.discord||'', other: obj.other||'' };
      const avatar = obj.avatar || `https://api.dicebear.com/8.x/fun-emoji/svg?seed=${encodeURIComponent(obj.nickname||'user')}`;
      const p = { id: crypto.randomUUID(), name: obj.name, nickname: obj.nickname, faculty: obj.faculty, major: obj.major||'', province: obj.province||'', bio: obj.bio||'', avatar, socials, createdAt: Date.now() };
      state.profiles = [p, ...state.profiles]; save('mf_profiles', state.profiles);
      closeModal('addModal');
      renderAll();
    };
    openModal('addModal');
  }

  // ===== Groups Modal =====
  function openGroupsModal(){
    const wrap = el('groupsEditor');
    wrap.innerHTML = '';
    const renderRows = ()=>{
      wrap.innerHTML = state.groups.map((g,i)=>{
        const opts = FACULTIES.map(f=>`<option ${g.faculty===f?'selected':''} value="${f}">${f}</option>`).join('');
        const links = g.links.map((l,j)=>`
          <div class="grid grid-cols-3 gap-2">
            <select data-type data-i="${i}" data-j="${j}" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100">
              ${['LINE','Facebook Group','Discord','Telegram','อื่น ๆ'].map(t=>`<option ${l.type===t?'selected':''} value="${t}">${t}</option>`).join('')}
            </select>
            <input data-url data-i="${i}" data-j="${j}" value="${l.url}" placeholder="URL เข้ากลุ่ม" class="col-span-2 bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/>
          </div>`).join('');
        return `
          <div class="border border-gray-700 rounded-2xl p-3 bg-gray-800/50">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <select data-faculty data-i="${i}" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"><option value="">— เลือกคณะ —</option>${opts}</select>
              <input data-major data-i="${i}" value="${g.major||''}" placeholder="สาขา (ไม่บังคับ)" class="bg-gray-800 border border-gray-700 rounded-xl px-3 py-2 text-gray-100"/>
              <button data-remove data-i="${i}" class="text-sm px-3 py-2 rounded-xl border border-red-500/40 text-red-300 hover:bg-red-500/10">ลบชุดนี้</button>
            </div>
            <div class="mt-2 space-y-2">${links}
              <button data-addlink data-i="${i}" class="text-xs px-2 py-1 rounded-lg border border-amber-400/40 text-amber-300 hover:bg-amber-400/10">เพิ่มลิงก์</button>
            </div>
          </div>`;
      }).join('');
    };
    renderRows();

    wrap.addEventListener('input', (e)=>{
      const t = e.target;
      if(t.hasAttribute('data-faculty')){ state.groups[t.dataset.i].faculty = t.value; }
      if(t.hasAttribute('data-major')){ state.groups[t.dataset.i].major = t.value; }
      if(t.hasAttribute('data-type')){ state.groups[t.dataset.i].links[t.dataset.j].type = t.value; }
      if(t.hasAttribute('data-url')){ state.groups[t.dataset.i].links[t.dataset.j].url = t.value; }
    });
    wrap.addEventListener('click', (e)=>{
      const t = e.target;
      if(t.hasAttribute('data-remove')){ state.groups.splice(t.dataset.i,1); renderRows(); }
      if(t.hasAttribute('data-addlink')){ state.groups[t.dataset.i].links.push({ type:'LINE', url:''}); renderRows(); }
    });

    el('btnAddGroupRow').onclick = ()=>{ state.groups.push({ id: crypto.randomUUID(), faculty:'', major:'', links:[{type:'LINE', url:''}]}); renderRows(); };
    el('btnSaveGroups').onclick = ()=>{ save('mf_groups', state.groups); closeModal('groupsModal'); renderAll(); };

    openModal('groupsModal');
  }

  // ===== Export/Import =====
  function mountExportImport(){
    const box = el('exportImport');
    const wrap = document.createElement('div');
    wrap.className = 'flex gap-2';
    const btnExp = document.createElement('button');
    btnExp.className = 'px-3 py-2 rounded-xl border border-gray-600 text-gray-200 hover:bg-gray-800 text-sm';
    btnExp.textContent = 'Export';
    btnExp.onclick = ()=>{
      const blob = new Blob([JSON.stringify({profiles:state.profiles, groups:state.groups}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = `makefriend-export-${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    };
    const btnImp = document.createElement('button');
    btnImp.className = 'px-3 py-2 rounded-xl border border-gray-600 text-gray-200 hover:bg-gray-800 text-sm';
    btnImp.textContent = 'Import';
    const file = document.createElement('input'); file.type='file'; file.accept='application/json'; file.className='hidden';
    btnImp.onclick = ()=> file.click();
    file.onchange = (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj.profiles) state.profiles=obj.profiles; if(obj.groups) state.groups=obj.groups; save('mf_profiles', state.profiles); save('mf_groups', state.groups); renderAll(); }catch{} }; r.readAsText(f); };
    wrap.append(btnExp, btnImp, file); box.append(wrap);
  }

  // ===== Helpers =====
  function openModal(id){ const m = el(id); m.classList.remove('hidden'); }
  function closeModal(id){ const m = el(id); m.classList.add('hidden'); }

  // ===== Events =====
  document.addEventListener('click', (e)=>{
    if(e.target.matches('[data-close]')){ closeModal('addModal'); closeModal('groupsModal'); closeDrawer(); }
    if(e.target.id==='btnAddProfile' || e.target.id==='btnAddProfileSm'){ openAddModal(); }
    if(e.target.id==='btnManageGroups' || e.target.id==='btnManageGroupsSm'){ openGroupsModal(); }
  });

  document.addEventListener('input', (e)=>{
    if(e.target===qEl){ state.q = e.target.value; renderAll(); }
    if(e.target===facultyEl){ state.faculty = e.target.value; state.major=''; majorEl.value=''; renderMajorsDatalist(); renderAll(); }
    if(e.target===majorEl){ state.major = e.target.value; renderAll(); }
  });

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-open-profile]');
    if(btn){ const id = btn.getAttribute('data-open-profile'); const p = state.profiles.find(x=>x.id===id); if(p) openDrawer(p); }
  });

  el('btnClearFilters').onclick = ()=>{ state.q=''; state.faculty=''; state.major=''; qEl.value=''; facultyEl.value=''; majorEl.value=''; renderAll(); };

  el('drawer').addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeDrawer(); });
  el('addModal').addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeModal('addModal'); });
  el('groupsModal').addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeModal('groupsModal'); });

  // ===== Init =====
  mountExportImport();
  renderAll();
  </script>
</body>
</html>
